<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reserva de Chal√©s</title>
  <link rel="stylesheet" href="css/index.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body>
  <header>
    <h1>Chal√©s da Serra Cuit√© PB</h1>
    <p>Reserve seu ref√∫gio perfeito</p>
  </header>

  <main>
    <section class="chales">
      <div class="card" data-chale="vista-da-montanha">
        <img src="img/chale.jpg" alt="Chal√© 1">
        <div class="card-body">
          <h3>Chal√© Vista da Montanha</h3>
          <p>2 camas ‚Ä¢ 1 banheiro ‚Ä¢ Wi-Fi ‚Ä¢ Caf√© da manh√£</p>
          <input type="text" class="cliente" placeholder="Seu nome">
          <input type="text" class="telefone" placeholder="Seu WhatsApp (somente n√∫meros)">
          <input type="date" class="checkin">
          <input type="date" class="checkout">
          <button class="btn" onclick="reservar(this)">Reservar</button>
          <h4>Reservas:</h4>
          <ul class="lista-reservas"></ul>
          <p class="indisponivel" style="color:red; font-weight:bold; display:none;">Indispon√≠vel!</p>
        </div>
      </div>

      <div class="card" data-chale="beira-do-lago">
        <img src="img/chale.jpg" alt="Chal√© 2">
        <div class="card-body">
          <h3>Chal√© Beira do Lago</h3>
          <p>3 camas ‚Ä¢ 2 banheiros ‚Ä¢ Piscina ‚Ä¢ Churrasqueira</p>
          <input type="text" class="cliente" placeholder="Seu nome">
          <input type="text" class="telefone" placeholder="Seu WhatsApp (somente n√∫meros)">
          <input type="date" class="checkin">
          <input type="date" class="checkout">
          <button class="btn" onclick="reservar(this)">Reservar</button>
          <h4>Reservas:</h4>
          <ul class="lista-reservas"></ul>
          <p class="indisponivel" style="color:red; font-weight:bold; display:none;">Indispon√≠vel!</p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <p>üìû WhatsApp: (84) 99999-9999 | ‚úâÔ∏è Email: dono@chales.com</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD1Q8VDgI1KdCno6KGuS8qg7Ms-9lpUjbc",
      authDomain: "chales-serra.firebaseapp.com",
      projectId: "chales-serra",
      storageBucket: "chales-serra.firebasestorage.app",
      messagingSenderId: "48224143566",
      appId: "1:48224143566:web:ca3a46c5a6ad3561c0a89f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function carregarReservas() {
      const cards = document.querySelectorAll('.card');
      for (let card of cards) {
        const chaleId = card.dataset.chale;
        const lista = card.querySelector('.lista-reservas');
        lista.innerHTML = '';
        const reservasRef = collection(db, "reservas");
        const q = query(reservasRef, where("chaleId", "==", chaleId));
        const snapshot = await getDocs(q);
        snapshot.forEach(doc => {
          const data = doc.data();
          const li = document.createElement('li');
          li.textContent = `${data.cliente}: ${data.checkin} √† ${data.checkout}`;
          lista.appendChild(li);
        });
      }
    }

    window.reservar = async function (btn) {
      const cardBody = btn.closest('.card-body');
      const card = btn.closest('.card');
      const chaleId = card.dataset.chale;
      const cliente = cardBody.querySelector('.cliente').value;
      const checkin = cardBody.querySelector('.checkin').value;
      const checkout = cardBody.querySelector('.checkout').value;
      const telefone = cardBody.querySelector('.telefone').value;

      if (!cliente || !checkin || !checkout || !telefone) {
        Swal.fire({
          title: '‚ö†Ô∏è Campos incompletos!',
          text: 'Preencha todos os campos antes de reservar.',
          icon: 'warning',
          confirmButtonText: 'Ok'
        });
        return;
      }

      if (new Date(checkout) < new Date(checkin)) {
        Swal.fire({
          title: '‚ö†Ô∏è Data inv√°lida!',
          text: 'A data de check-out n√£o pode ser antes do check-in.',
          icon: 'warning',
          confirmButtonText: 'Ok'
        });
        return;
      }

      try {
        const reservasRef = collection(db, "reservas");

        const q = query(
          reservasRef,
          where("chaleId", "==", chaleId),
          where("checkin", "<=", checkout),
          where("checkout", ">=", checkin)
        );

        const snapshot = await getDocs(q);

        if (!snapshot.empty) {
          Swal.fire({
            title: '‚ö†Ô∏è Indispon√≠vel!',
            text: 'O chal√© j√° est√° reservado nessas datas.',
            icon: 'error',
            confirmButtonText: 'Ok'
          });
          return;
        }

        await addDoc(reservasRef, {
          chaleId,
          checkin,
          checkout,
          cliente,
          telefone,
          timestamp: new Date().toISOString()
        });

        Swal.fire({
          title: '‚úÖ Reserva Confirmada!',
          html: `<p>Chal√©: <b>${chaleId}</b></p>
                 <p>Cliente: <b>${cliente}</b></p>
                 <p>Check-in: <b>${checkin}</b></p>
                 <p>Check-out: <b>${checkout}</b></p>`,
          icon: 'success',
          confirmButtonText: 'Ok'
        });

        cardBody.querySelector('.cliente').value = '';
        cardBody.querySelector('.checkin').value = '';
        cardBody.querySelector('.checkout').value = '';
        cardBody.querySelector('.telefone').value = '';

        carregarReservas();
      } catch (error) {
        console.error("Erro ao reservar:", error);
        Swal.fire({
          title: '‚ùå Erro ao reservar',
          text: 'Ocorreu um problema, veja o console.',
          icon: 'error',
          confirmButtonText: 'Ok'
        });
      }
    }

    window.addEventListener('DOMContentLoaded', carregarReservas);
  </script>
</body>

</html>
